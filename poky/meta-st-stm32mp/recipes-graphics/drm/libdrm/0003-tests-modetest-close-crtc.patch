From d6bca867d77853abb6f1c74a65d70ceb12904ec5 Mon Sep 17 00:00:00 2001
From: Christophe Priouzeau <christophe.priouzeau@foss.st.com>
Date: Mon, 18 Mar 2024 14:09:49 +0100
Subject: [PATCH 3/3] tests/modetest: close crtc

To test several configuration of crtc, it must be closed at the end
of modetest test (with/without atomic mode).

Signed-off-by: Yannick Fertre <yannick.fertre@st.com>
Upstream-Status: Inappropriate
---
 tests/modetest/modetest.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/tests/modetest/modetest.c b/tests/modetest/modetest.c
index 4a598e5..3259ec0 100644
--- a/tests/modetest/modetest.c
+++ b/tests/modetest/modetest.c
@@ -2426,6 +2426,10 @@ int main(int argc, char **argv)
 		if (count && plane_count)
 			atomic_clear_FB(&dev, plane_args, plane_count);
 
+		for (i = 0; i < count; i++)
+			drmModeSetCrtc(dev.fd, dev.resources->crtcs[i].crtc->crtc_id,
+					       0, 0, 0, 0, 0, NULL);
+
 		drmModeAtomicFree(dev.req);
 	} else {
 		for (i = 0; i < prop_count; ++i)
@@ -2462,6 +2466,10 @@ int main(int argc, char **argv)
 
 			getchar();
 
+			for (i = 0; i < count; i++)
+				drmModeSetCrtc(dev.fd, dev.resources->crtcs[i].crtc->crtc_id,
+					       0, 0, 0, 0, 0, NULL);
+
 			if (test_cursor)
 				clear_cursors(&dev);
 
-- 
2.34.1

