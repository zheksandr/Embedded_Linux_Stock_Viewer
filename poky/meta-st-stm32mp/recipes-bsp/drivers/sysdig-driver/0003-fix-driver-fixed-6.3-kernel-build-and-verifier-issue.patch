From 839e16d524053dab22fea82e18d7c841001221d7 Mon Sep 17 00:00:00 2001
From: Federico Di Pierro <nierro92@gmail.com>
Date: Tue, 2 May 2023 13:08:33 +0200
Subject: [PATCH] fix(driver): fixed 6.3 kernel build and verifier issues.

Upstream-Status: Backport [https://github.com/falcosecurity/libs/pull/1071]

Signed-off-by: Federico Di Pierro <nierro92@gmail.com>
---
 driver/bpf/fillers.h                          | 24 +++++++++++++
 .../definitions/missing_definitions.h         |  2 ++
 .../modern_bpf/definitions/struct_flavors.h   |  5 +++
 .../helpers/extract/extract_from_kernel.h     | 36 +++++++++++++++----
 driver/ppm_fillers.c                          | 24 +++++++++++--
 5 files changed, 82 insertions(+), 9 deletions(-)

diff --git a/driver/ppm_fillers.c b/driver/ppm_fillers.c
index 0403566aa..868b5a077 100644
--- a/driver/ppm_fillers.c
+++ b/driver/ppm_fillers.c
@@ -1329,7 +1329,10 @@ cgroups_error:

 		if (exe_file != NULL) {
 			if (file_inode(exe_file) != NULL) {
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 12, 0)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 3, 0)
+				exe_writable |= (file_permission(exe_file, MAY_WRITE) == 0);
+				exe_writable |= inode_owner_or_capable(file_mnt_idmap(exe_file), file_inode(exe_file));
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(5, 12, 0)
 				exe_writable |= (inode_permission(current_user_ns(), file_inode(exe_file), MAY_WRITE) == 0);
 				exe_writable |= inode_owner_or_capable(current_user_ns(), file_inode(exe_file));
 #else
-- 
2.25.1

